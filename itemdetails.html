<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Item Details – ReUseIt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { background-color: #f8f9fa; }
    .navbar { box-shadow: 0 2px 15px rgba(0,0,0,0.1); padding: 12px 0; }
    .navbar-brand { font-weight: 800; color: #006A4E !important; font-size: 1.8rem; }
    .nav-link { font-weight: 600; color: #343A40 !important; transition: all 0.3s ease; position: relative; }
    .nav-link:hover { color: #FF6B35 !important; }
    .nav-link::after {
      content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 0;
      background-color: #FF6B35; transition: width 0.3s ease;
    }
    .nav-link:hover::after { width: 100%; }
    .nav-link.text-success { color: #198754 !important; }
    .nav-link.text-success:hover { color: #157347 !important; }
    .nav-link.text-danger { color: #dc3545 !important; }
    .nav-link.text-danger:hover { color: #bb2d3b !important; }

    .card { box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .modal-content { border-radius: 12px; }
    .modal-header { border-bottom: 1px solid #e9ecef; }
    .modal-footer { border-top: 1px solid #e9ecef; }
    .item-detail-row { margin-bottom: 12px; }
    .detail-label { font-weight: 500; color: #495057; }
    .detail-value { color: #212529; }
    .seller-info { background-color: #f8f9fa; border-radius: 8px; padding: 16px; }

    .item-image {
    width: 100%;
    max-width: 500px;   /* adjust max width */
    height: 400px;      /* fixed height for uniformity */
    object-fit: contain; /* ensures image scales proportionally */
    border-radius: 8px;
    background-color: #fff; /* optional - clean background if image is smaller */
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  </style>
</head>
<body>

<!-- ✅ Navbar copied from index.html -->
<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
  <div class="container">
    <a class="navbar-brand" href="index.html">
      <i class="fas fa-recycle me-2"></i>ReUseIt
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="browse.html">Browse Items</a></li>
        <li class="nav-item"><a class="nav-link" href="post item.html">Post an Item</a></li>
        <li class="nav-item"><a class="nav-link" href="Swap.html">Swap Zone</a></li>
        <li class="nav-item" id="userNav">
          <a class="nav-link" href="login.html" id="loginLink">Login</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Item Section -->
<div class="container py-5">
  <div class="row g-4">
    <div class="col-md-6 d-flex justify-content-center align-items-center">
  <img id="itemImage" src="" 
       class="item-image" 
       alt="Item Image">
</div>
    <div class="col-md-6">
      <div class="card p-4">
        <h3 id="itemTitle">Loading...</h3>
        <p id="itemPrice" class="text-muted fs-5"></p>
        <p id="itemDescription"></p>

        <h5>Seller Contact Info</h5>
        <p><strong>Name:</strong> <span id="sellerName"></span></p>
        <p><strong>Email:</strong> <span id="sellerEmail"></span></p>
        <p><strong>Phone:</strong> <span id="sellerPhone"></span></p>

        <div class="d-flex gap-2 mt-3">
          <!-- removed automatic data-bs-toggle/data-bs-target so JS controls opening -->
          <button class="btn btn-success" id="chatBtn">Chat with Seller</button>
          <button class="btn btn-primary" id="buyBtn">Buy Now</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chat Modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Chat with Seller</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" rows="4" placeholder="Type your message..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Buy Modal -->
<div class="modal fade" id="buyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Purchase</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <h6 class="section-title">Item Details</h6>
            <div class="row item-detail-row">
              <div class="col-5 detail-label">Item:</div>
              <div class="col-7 detail-value" id="modalItemTitle"></div>
            </div>
            <div class="row item-detail-row">
              <div class="col-5 detail-label">Price:</div>
              <div class="col-7 detail-value" id="modalItemPrice"></div>
            </div>
            <div class="row item-detail-row">
              <div class="col-5 detail-label">Condition:</div>
              <div class="col-7 detail-value" id="modalItemCondition"></div>
            </div>
            <div class="row item-detail-row">
              <div class="col-5 detail-label">Description:</div>
              <div class="col-7 detail-value" id="modalItemDescription"></div>
            </div>
          </div>
          <div class="col-md-6">
            <h6 class="section-title">Seller Information</h6>
            <div class="seller-info">
              <div class="row item-detail-row">
                <div class="col-5 detail-label">Name:</div>
                <div class="col-7 detail-value" id="modalSellerName"></div>
              </div>
              <div class="row item-detail-row">
                <div class="col-5 detail-label">Email:</div>
                <div class="col-7 detail-value" id="modalSellerEmail"></div>
              </div>
              <div class="row item-detail-row">
                <div class="col-5 detail-label">Phone:</div>
                <div class="col-7 detail-value" id="modalSellerPhone"></div>
              </div>
            </div>
          </div>
        </div>
        
        <hr>
        
        <h6 class="section-title">Your Information</h6>
        <p class="text-muted mb-3">Please provide your details to complete the purchase</p>
        
        <div class="buyer-info">
          <form id="buyerForm">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="buyerName" class="form-label required-field">Full Name</label>
                <input type="text" class="form-control" id="buyerName" placeholder="Enter your full name">
              </div>
              <div class="col-md-6">
                <label for="buyerEmail" class="form-label required-field">Email Address</label>
                <input type="email" class="form-control" id="buyerEmail" placeholder="Enter your email">
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="buyerPhone" class="form-label required-field">Phone Number</label>
                <input type="tel" class="form-control" id="buyerPhone" placeholder="Enter your phone number">
              </div>
              <div class="col-md-6">
                <label for="buyerAddress" class="form-label required-field">Delivery Address</label>
                <textarea class="form-control" id="buyerAddress" rows="2" placeholder="Enter your complete address"></textarea>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-12">
                <label for="buyerMessage" class="form-label">Message to Seller (Optional)</label>
                <textarea class="form-control" id="buyerMessage" rows="2" placeholder="Any special instructions or questions"></textarea>
              </div>
            </div>
          </form>
        </div>
        
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="termsCheck">
          <label class="form-check-label" for="termsCheck">
            I agree to the terms and conditions
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmPurchaseBtn" disabled>Confirm Purchase</button>
      </div>
    </div>
  </div>
</div>

<!-- Final Confirmation Modal -->
<div class="modal fade" id="finalConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Purchase Successful</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Your purchase has been confirmed with the following details:</p>
        <table class="table table-bordered">
          <tbody>
            <tr><th>Item</th><td id="confirmItem"></td></tr>
            <tr><th>Price</th><td id="confirmPrice"></td></tr>
            <tr><th>Condition</th><td id="confirmCondition"></td></tr>
            <tr><th>Buyer Name</th><td id="confirmBuyerName"></td></tr>
            <tr><th>Email</th><td id="confirmBuyerEmail"></td></tr>
            <tr><th>Phone</th><td id="confirmBuyerPhone"></td></tr>
            <tr><th>Address</th><td id="confirmBuyerAddress"></td></tr>
            <tr><th>Message</th><td id="confirmBuyerMessage"></td></tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="okRedirectBtn">OK</button>
      </div>
    </div>
  </div>
</div>


<footer class="bg-dark text-light text-center py-3 mt-5">
  <p>&copy; 2025 ReUseIt | Item Details</p>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ✅ Session check logic copied from index.html -->
<script>
async function checkSession() {
  try {
    const res = await fetch('http://127.0.0.1:3000/session', { credentials: 'include' });
    const data = await res.json();
    const userNav = document.getElementById('userNav');

    if (data.user) {
      userNav.innerHTML = `
        <div class="d-flex align-items-center">
          <span class="nav-link fw-bold text-success me-2">
            <i class="fas fa-user-circle me-1"></i>${data.user.name}
          </span>
          <a href="#" class="nav-link text-danger fw-semibold" id="logoutBtn">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </a>
        </div>
      `;

      document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        await fetch('http://127.0.0.1:3000/logout', { credentials: 'include' });
        window.location.href = "index.html";
      });
    }
  } catch (err) {
    console.error("Session check failed:", err);
  }
}

document.addEventListener("DOMContentLoaded", checkSession);
</script>

<!-- 1. Load items database -->
<script src="items.js"></script>

<!-- 2. Custom script (must come after items.js) -->
<script>
  // Global flag for session
  let loggedIn = false;

  // Get the item ID from URL parameters
  const params = new URLSearchParams(window.location.search);
  const itemId = params.get("id");

  // Function to extract condition from description
  function extractCondition(description) {
    if (description.toLowerCase().includes('slightly used') || 
        description.toLowerCase().includes('lightly used')) {
      return 'Slightly used';
    } else if (description.toLowerCase().includes('like new') || 
               description.toLowerCase().includes('excellent condition')) {
      return 'Like new';
    } else if (description.toLowerCase().includes('good condition')) {
      return 'Good condition';
    } else if (description.toLowerCase().includes('fair condition') ||
               description.toLowerCase().includes('well used')) {
      return 'Fair condition';
    } else {
      return 'Used';
    }
  }

  // Populate item details if item found in itemsData
  if (itemId && typeof itemsData !== "undefined" && itemsData[itemId]) {
    const item = itemsData[itemId];
    const condition = extractCondition(item.description);

    // Set item image - encode spaces in filenames
    document.getElementById("itemImage").src = encodeURI(item.image);
    
    // Set item details
    document.getElementById("itemTitle").textContent = item.title;
    document.getElementById("itemPrice").textContent = item.price;
    document.getElementById("itemDescription").textContent = item.description;

    // Set seller information
    document.getElementById("sellerName").textContent = item.seller.name;
    document.getElementById("sellerEmail").textContent = item.seller.email;
    document.getElementById("sellerPhone").textContent = item.seller.phone;

    // Set modal information
    document.getElementById("modalItemTitle").textContent = item.title;
    document.getElementById("modalItemPrice").textContent = item.price;
    document.getElementById("modalItemCondition").textContent = condition;
    document.getElementById("modalItemDescription").textContent = item.description;
    document.getElementById("modalSellerName").textContent = item.seller.name;
    document.getElementById("modalSellerEmail").textContent = item.seller.email;
    document.getElementById("modalSellerPhone").textContent = item.seller.phone;
  } else {
    document.getElementById("itemTitle").textContent = "Item not found!";
    document.getElementById("itemDescription").textContent = "The requested item could not be found. Please go back to the browse page and try again.";
  }

  // Enable confirm purchase button only when terms are agreed and required fields are filled
  function validateForm() {
    const termsAgreed = document.getElementById('termsCheck').checked;
    const nameFilled = document.getElementById('buyerName').value.trim() !== '';
    const emailFilled = document.getElementById('buyerEmail').value.trim() !== '';
    const phoneFilled = document.getElementById('buyerPhone').value.trim() !== '';
    const addressFilled = document.getElementById('buyerAddress').value.trim() !== '';
    
    document.getElementById('confirmPurchaseBtn').disabled = 
      !(termsAgreed && nameFilled && emailFilled && phoneFilled && addressFilled);
  }
  
  // Add event listeners to all required fields and terms checkbox
  document.getElementById('termsCheck').addEventListener('change', validateForm);
  document.getElementById('buyerName').addEventListener('input', validateForm);
  document.getElementById('buyerEmail').addEventListener('input', validateForm);
  document.getElementById('buyerPhone').addEventListener('input', validateForm);
  document.getElementById('buyerAddress').addEventListener('input', validateForm);
  
  // Handle purchase confirmation

console.log("Item ID:", itemId);
console.log("Item data:", itemsData[itemId]);


document.getElementById('confirmPurchaseBtn').addEventListener('click', async function() {
  try {
    // Get buyer information
    const buyerName = document.getElementById('buyerName').value.trim();
    const buyerEmail = document.getElementById('buyerEmail').value.trim();
    const buyerPhone = document.getElementById('buyerPhone').value.trim();
    const buyerAddress = document.getElementById('buyerAddress').value.trim();
    const buyerMessage = document.getElementById('buyerMessage').value.trim();

    // Get item information from modal
    const itemTitle = document.getElementById("modalItemTitle").textContent;
    const itemPrice = document.getElementById("modalItemPrice").textContent;
    const itemCondition = document.getElementById("modalItemCondition").textContent;

    // Make sure itemId is sent
    const itemId = params.get("id"); // from URL

    if (!itemId) {
      alert("Item ID not found. Cannot proceed with purchase.");
      return;
    }

    // Send data to backend
    const response = await fetch("http://127.0.0.1:3000/purchase", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        itemId,
        itemTitle,
        itemPrice,
        itemCondition,
        buyerName,
        buyerEmail,
        buyerPhone,
        buyerAddress,
        buyerMessage
      })
    });

    const result = await response.json();

    if (!response.ok) {
      console.error("Error saving purchase:", result.error);
      alert("Failed to save purchase. Please try again.");
      return;
    }

    // Close buy modal
    const buyModal = bootstrap.Modal.getInstance(document.getElementById('buyModal'));
    if (buyModal) buyModal.hide();

    // Fill confirmation modal table
    document.getElementById('confirmItem').textContent = itemTitle;
    document.getElementById('confirmPrice').textContent = itemPrice;
    document.getElementById('confirmCondition').textContent = itemCondition;
    document.getElementById('confirmBuyerName').textContent = buyerName;
    document.getElementById('confirmBuyerEmail').textContent = buyerEmail;
    document.getElementById('confirmBuyerPhone').textContent = buyerPhone;
    document.getElementById('confirmBuyerAddress').textContent = buyerAddress;
    document.getElementById('confirmBuyerMessage').textContent = buyerMessage || "—";

    // Show final confirmation modal
    const finalModal = new bootstrap.Modal(document.getElementById('finalConfirmModal'));
    finalModal.show();

    document.getElementById("okRedirectBtn").addEventListener("click", function() {
      window.location.href = "browse.html";
    });

    // Reset form
    document.getElementById('buyerForm').reset();
    document.getElementById('termsCheck').checked = false;
    document.getElementById('confirmPurchaseBtn').disabled = true;

  } catch (err) {
    console.error("Error during purchase:", err);
    alert("An unexpected error occurred. Please try again.");
  }
});



  // ---------- Session check and gated modal opening ----------
  async function checkSessionAndUpdateNav() {
    try {
      const res = await fetch('http://127.0.0.1:3000/session', { credentials: 'include' });
      // If server returns non-JSON or error, this may throw — catch below
      const data = await res.json();
      const userNav = document.getElementById('userNav');
      if (data && data.user) {
        loggedIn = true;
        // replace login with user name + logout
        userNav.innerHTML = `
          <div class="d-flex align-items-center">
            <span class="nav-link fw-bold text-success me-2">
              <i class="fas fa-user-circle me-1"></i>${data.user.name}
            </span>
            <a href="#" class="nav-link text-danger fw-semibold" id="logoutBtn">
              <i class="fas fa-sign-out-alt me-1"></i>Logout
            </a>
          </div>
        `;
        // attach logout handler
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
              await fetch('http://127.0.0.1:3000/logout', { credentials: 'include' });
            } catch (err) {
              console.error('Logout error:', err);
            }
            window.location.href = "index.html";
          });
        }
      } else {
        loggedIn = false;
        // leave login link as-is (userNav already shows login anchor)
      }
    } catch (err) {
      console.warn("Session check failed (user considered logged out):", err);
      loggedIn = false;
    }
  }

  // Run session check immediately
  checkSessionAndUpdateNav();

  // Chat & Buy button handlers (gate actions by login state)
  document.getElementById('chatBtn').addEventListener('click', function () {
    if (!loggedIn) {
      alert('Please login to chat with the seller.');
      return;
    }
    const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
    chatModal.show();
  });

  document.getElementById('buyBtn').addEventListener('click', function () {
    if (!loggedIn) {
      alert('Please login to buy this item.');
      return;
    }
    const buyModal = new bootstrap.Modal(document.getElementById('buyModal'));
    buyModal.show();
  });
</script>
</body>
</html>
